const chatToggle = document.getElementById('chatbot-toggle');
const chatContainer = document.getElementById('chat-container');
const closeBtn = document.getElementById('close-btn');
const options = document.getElementById('options');
const subOptions = document.getElementById('sub-options');
const userInput = document.getElementById('user-input');

// Inicia o chatbot fechado
chatContainer.style.display = 'none';


chatToggle.addEventListener('click', () => {
    if (chatContainer.style.display === 'block') {
        chatContainer.style.display = 'none';
    } else {
        chatContainer.style.display = 'block';
        options.style.display = 'block'; // Mostra op√ß√µes ao abrir
        subOptions.style.display = 'none'; // Oculta sub-op√ß√µes ao abrir
        userInput.value = ''; // Limpa campo de entrada
        mainOptions.style.display = 'block'; // Assegura que as op√ß√µes principais estejam vis√≠veis
    }
});



closeBtn.addEventListener('click', () => {
    chatContainer.style.display = 'none';
    options.style.display = 'none'; // Oculta op√ß√µes ao fechar
    subOptions.style.display = 'none'; // Oculta sub-op√ß√µes ao fechar
});


function showMainOptions() {
    options.style.display = 'block'; // Mostra as op√ß√µes principais
    subOptions.style.display = 'none'; // Oculta as sub-op√ß√µes
}

function showInitialMessage() {
    const initialMessage = `
        üëã Ol√°! Sou o ChatiBIDEN, pronto para te ajudar a entender mais sobre o clima e os casos de dengue! 
        Como posso te ajudar hoje? Escolha uma das op√ß√µes abaixo ou digite <strong>Dengue</strong> para come√ßar:
        <ul id="main-options">
            <li><a href="{{ url_for('busca_clima')}}">Ver dados clim√°ticos üå¶Ô∏è</a></li>
            <li><a href="{{ url_for('dengueinsight')}}">Visualizar M√©tricas da Dengue ü¶ü</a></li>
            <li><a href="{{ url_for('casosgrafico')}}">Previs√£o da Dengue üö®</a></li>
            <li><a href="{{ url_for('buscar_impactos')}}">Saber mais sobre Impactos Ambientais üî•</a></li>
            <li><a href="{{ url_for('mapadengue')}}">Mapa da Dengue no Brasil üåé</a></li>
            <li><a href="{{ url_for('dashboard')}}">Acessar Dashboard üìà</a></li>
            <li><a class="option-btn" href="#" onclick="showSubOptions()">Explica√ß√£o do Dashboard üë®‚Äçüè´</a></li>
        </ul>
    `;
    
    addMessage('bot', initialMessage); // Adiciona a mensagem inicial ao chat
}

let currentContext = '';

function generateBotResponse(message) {
    const lowerMessage = message.toLowerCase();

    const includesKeywords = (keywords) => keywords.some(keyword => lowerMessage.includes(keyword));

    if (includesKeywords(['menu', 'voltar pro menu', 'voltar', 'menu principal', 'principal'])) {
        // Limpa o chat antes de mostrar as op√ß√µes
        const chatBox = document.getElementById('chat-box');
        chatBox.innerHTML = ''; // Limpa todas as mensagens do chat
        currentContext = ''; // Reseta o contexto
        showInitialMessage(); // Adiciona a mensagem inicial
        showMainOptions(); // Exibe as op√ß√µes principais
        return; // Termina a execu√ß√£o aqui
    }

    // Respostas com base no contexto atual
    if (currentContext === 'sintomas' && includesKeywords(['como se proteger', 'preven√ß√£o', 'proteger'])) {
        addMessage('bot', 'Para se proteger da dengue, √© importante eliminar √°gua parada, usar repelentes e evitar locais com alta incid√™ncia de mosquitos. Para saber mais digite <strong>medidas de controle</strong>');
        currentContext = 'prote√ß√£o';
        return;
    } else if (currentContext === 'sintomas' && includesKeywords(['sintomas graves', 'graves'])) {
        addMessage('bot', 'Os sintomas graves da dengue incluem sangramentos, dor abdominal intensa e dificuldade para respirar. √â importante procurar atendimento m√©dico imediatamente. Posso ajudar com mais alguma informa√ß√£o?');
        currentContext = ''; // Finaliza o contexto ap√≥s a resposta completa
        return;
    } else if (currentContext === 'prote√ß√£o' && includesKeywords(['medidas de controle', 'controle', 'controle mosquito'])) {
        addMessage('bot', 'As medidas de controle incluem o uso de inseticidas e a limpeza de locais onde o mosquito possa se reproduzir. Para saber mais digite <strong>como colaborar</strong>');
        currentContext = 'controle';
        return;
    } else if (currentContext === 'controle') {
        if (includesKeywords(['sim'])) {
            addMessage('bot', 'Voc√™ pode colaborar informando a sua comunidade sobre a import√¢ncia de eliminar √°gua parada e reportando focos do mosquito. Alguma outra d√∫vida?');
            currentContext = 'd√∫vidas'; // Agora estamos no contexto de d√∫vidas
            return;
        } else if (includesKeywords(['n√£o'])) {
            addMessage('bot', 'Obrigado pela conversa! üòä Se precisar de mais informa√ß√µes, estarei por aqui! Caso queira voltar para o menu inicial, digite "menu"');
            currentContext = ''; // Finaliza o contexto
            return;
        }
    }

    // Respostas gerais (fora de um contexto espec√≠fico)
    if (includesKeywords(['dengue', 'doen√ßa', 'mosquito'])) {
        addMessage('bot', 'A dengue √© uma doen√ßa viral. Voc√™ gostaria de saber mais sobre <strong>sintomas</strong>, <strong>preven√ß√£o</strong>, <strong>vacina√ß√£o</strong> ou <strong>transmiss√£o</strong>?');
        currentContext = '';
    } else if (includesKeywords(['sintoma', 'sintomas'])) {
        addMessage('bot', 'Os sintomas da dengue incluem febre alta, dores de cabe√ßa e dores no corpo. Voc√™ gostaria de saber <strong>como se proteger</strong> ou <strong>quais s√£o os sintomas graves</strong>?');
        currentContext = 'sintomas';
    } else if (includesKeywords(['preven√ß√£o', 'prevenir'])) {
        addMessage('bot', 'A preven√ß√£o inclui eliminar √°gua parada e usar repelentes. Tem interesse em saber mais sobre <strong>tratamento</strong>, <strong>vacina√ß√£o</strong> ou <strong>medidas de controle</strong>?');
        currentContext = 'preven√ß√£o';
    } else if (includesKeywords(['vacina√ß√£o', 'vacina'])) {
        addMessage('bot', 'A vacina contra a dengue √© importante para prevenir a doen√ßa. Atualmente, existem v√°rias vacinas dispon√≠veis contra a dengue. A vacina√ß√£o √© recomendada para pessoas que vivem em √°reas de risco. Se precisar de mais informa√ß√µes, estarei por aqui. Alguma outra d√∫vida?');
        currentContext = 'vacina√ß√£o';
    } else if (includesKeywords(['tratamento', 'curar', 'cura'])) {
        addMessage('bot', 'O tratamento √© geralmente sintom√°tico, com hidrata√ß√£o e medicamentos. Posso ajudar com mais alguma coisa?');
        currentContext = ''; // Finaliza o contexto ap√≥s a resposta completa
    } else if (includesKeywords(['transmiss√£o', 'transmitir'])) {
        addMessage('bot', 'A dengue √© transmitida principalmente pelo mosquito Aedes aegypti. Para saber mais, digite <strong>como evitar picadas</strong>');
        currentContext = 'transmiss√£o';
    } else if (includesKeywords(['sintomas graves', 'grave', 'complica√ß√µes'])) {
        addMessage('bot', 'Os sintomas graves da dengue incluem sangramentos, dor abdominal intensa e dificuldade para respirar. √â importante procurar atendimento m√©dico imediatamente. Posso ajudar com mais alguma informa√ß√£o?');
        currentContext = ''; // Finaliza o contexto ap√≥s a resposta completa
    } else if (includesKeywords(['medidas de controle', 'medidas', 'medida','controle', 'controle mosquito', 'controle da dengue', 'controle dengue'])) {
        addMessage('bot', 'As medidas de controle incluem o uso de inseticidas e a limpeza de locais onde o mosquito possa se reproduzir. Para saber mais, digite <strong>como colaborar</strong>');
        currentContext = 'controle';
    } else if (includesKeywords(['como colaborar', 'ajudar', 'colabora√ß√£o'])) {
        addMessage('bot', 'Voc√™ pode colaborar informando a sua comunidade sobre a import√¢ncia de eliminar √°gua parada e reportando focos do mosquito. Alguma outra d√∫vida?');
        currentContext = 'd√∫vidas';
    } else if (includesKeywords(['sim'])) {
        addMessage('bot', 'Voc√™ pode me perguntar sobre <strong>dengue</strong>, <strong>sintomas</strong>, <strong>preven√ß√£o</strong>, <strong>tratamento</strong>, <strong>controle da dengue</strong>, <strong>transmiss√£o</strong>, ou <strong>vacina√ß√£o</strong>.');
        currentContext = '';

    } else if (includesKeywords(['n√£o', 'nao'])) {
        addMessage('bot', 'Obrigado pela conversa! Se precisar de mais informa√ß√µes, estarei por aqui. üòâ! Para voltar ao menu principal, digite "menu"');
        currentContext = ''; // Finaliza o contexto
    }
    else {
        addMessage('bot', 'Desculpe, n√£o entendi. Voc√™ pode me perguntar sobre <strong>dengue</strong>, <strong>sintomas</strong>, <strong>preven√ß√£o</strong>, <strong>tratamento</strong>, <strong>transmiss√£o</strong> ou <strong>vacina√ß√£o</strong>. Ou digite "menu" para voltar ao menu principal.');
        currentContext = ''; // Reseta o contexto em caso de erro
    }
}


function showSubOptions() {
    document.getElementById('sub-options').style.display = 'block'; // Mostrar as sub-op√ß√µes
    document.getElementById('main-options').style.display = 'block'; // Garante que as op√ß√µes principais est√£o vis√≠veis
}


function goBack() {
    document.getElementById('sub-options').style.display = 'none';
    document.getElementById('main-options').style.display = 'block';
}

function explainTopic(topic) {
    let explanation;

    switch (topic) {
        case 'aumento-temperatura':
            explanation = `üìàüå°Ô∏è A p√°gina mostra o aumento das temperaturas m√©dias anuais no Brasil ao longo das d√©cadas. De 1961-1990, a m√©dia era 22,33¬∞C, subindo para 23,60¬∞C entre 1990-2020. O gr√°fico tamb√©m revela que todos os meses tiveram eleva√ß√£o de temperatura nesse per√≠odo, indicando uma tend√™ncia de aquecimento cont√≠nuo, possivelmente causada pelas mudan√ßas clim√°ticas, o que pode influenciar a prolifera√ß√£o do Aedes aegypti.`;
            break;
        case 'dengue-e-clima':
            explanation = `A p√°gina mostra a correla√ß√£o entre temperatura üå°Ô∏è e casos de dengue ü¶ü ao longo dos anos. No gr√°fico de linhas (parte superior), podemos ver que tanto a temperatura quanto os casos de dengue aumentam e diminuem em conjunto üìà. Picos de temperatura mais alta costumam coincidir com o aumento dos casos de dengue, sugerindo que o calor contribui para a prolifera√ß√£o do mosquito transmissor ü¶†.
            <br><br>
            <strong>Destaque para 2020 (Ano da Pandemia üò∑):</strong>
            Em 2020, houve uma queda significativa nos casos de dengue, enquanto a temperatura permaneceu est√°vel. Isso pode ser resultado das medidas de distanciamento social e outras a√ß√µes adotadas durante a pandemia de COVID-19 üìâ.`;
            break;
        case 'dengue-e-chuva':
            explanation = `üåßÔ∏è O impacto da chuva na prolifera√ß√£o da dengue √© significativo, pois √°guas acumuladas ap√≥s chuvas intensas servem como criadouros para o mosquito. 
            <br>O gr√°fico mostra que os casos de dengue ü¶ü e a precipita√ß√£o üåßÔ∏è t√™m picos semelhantes ao longo dos anos e meses. Nos meses de maior chuva, como mar√ßo e abril, h√° um aumento expressivo nos casos de dengue üìà. J√° nos meses de menor precipita√ß√£o, como agosto e setembro, os casos caem bastante üìâ. Isso indica que a alta precipita√ß√£o favorece a prolifera√ß√£o do mosquito ü¶†.`;
            break;
        case 'como-se-proteger':
            explanation = `Para se proteger da dengue ü¶ü: elimine √°gua parada üíß, use repelente üß¥, mantenha janelas fechadas üö™, e descarte o lixo corretamente üóëÔ∏è. Com pequenas a√ß√µes, podemos evitar grandes problemas!<br><br>
            E para saber mais sobre impactos da Dengue, explore todas as ferramentas iBIDEN! ü§ó`;
            break;
        default:
            explanation = `Desculpe, n√£o consegui encontrar informa√ß√µes sobre esse t√≥pico.`;
    }

    // Adicionar a explica√ß√£o ao chat
    if (explanation) {
        addMessage('bot', explanation); // Passa o autor e a mensagem correta
    }
    
    // Agora esconde as sub-op√ß√µes depois que a mensagem foi adicionada
    document.getElementById('sub-options').style.display = 'none';
}





function addMessage(author, message) {
    const chatBox = document.getElementById('chat-box');
    const newMessage = document.createElement('div');

    // Adiciona a classe apropriada com base no autor
    newMessage.classList.add('message', author === 'user' ? 'user-message' : 'bot-message');

    // Verifica se a mensagem n√£o est√° vazia
    if (message) {
        newMessage.innerHTML = message; // Adiciona o conte√∫do da mensagem
    } else {
        newMessage.innerHTML = "Desculpe, n√£o consegui entender a sua mensagem."; // Mensagem padr√£o para erro
    }

    // Adiciona a nova mensagem ao chat
    chatBox.appendChild(newMessage);
    chatBox.scrollTop = chatBox.scrollHeight; // Desce o scroll para o final
}

// Exemplo de como voc√™ pode chamar a fun√ß√£o de explica√ß√£o
function onSubOptionClick(topic) {
    explainTopic(topic); // Chama a fun√ß√£o para explicar o t√≥pico
}

function sendMessage() {
    const message = userInput.value.trim();
    if (message) {
        addMessage('user', message); // Adiciona a mensagem do usu√°rio
        generateBotResponse(message); // Gera resposta do bot
        userInput.value = ''; // Limpa o campo de entrada ap√≥s enviar
        options.style.display = 'none'; // Esconde as op√ß√µes ap√≥s enviar a mensagem
        subOptions.style.display = 'none'; // Esconde as sub-op√ß√µes ap√≥s enviar a mensagem
    }
}

function toggleExplanation() {
    const mainOptions = document.getElementById('main-options');
    const subOptions = document.getElementById('sub-options');

    mainOptions.classList.toggle('hidden'); // Esconde as op√ß√µes principais
    subOptions.style.display = 'flex'; // Exibe as sub-op√ß√µes
}


// Exemplo de intera√ß√£o do usu√°rio
document.getElementById('sendButton').onclick = function() {
    const userMessage = document.getElementById('userInput').value;
    addMessage('user', userMessage);

    // Gerar resposta do bot
    generateBotResponse(userMessage);

    // Agora voc√™ pode chamar a fun√ß√£o handleUserResponse, se apropriado
    if (userMessage.includes('sim') || userMessage.includes('n√£o')) {
        handleUserResponse(userMessage);
    }
};

document.getElementById('sendButton').addEventListener('click', sendMessage);

// Permite enviar a mensagem pressionando "Enter"
userInput.addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
});
